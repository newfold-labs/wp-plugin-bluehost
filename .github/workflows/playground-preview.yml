name: WordPress Playground Preview
on:
  workflow_run:
    workflows: [ "Build Plugin" ]
    types: [ completed ]

# Disable permissions for all available scopes by default.
# Any needed permissions should be configured at the job level.
permissions: {}

jobs:
  deploy-preview:
    name: Deploy to GitHub Pages and Create Playground Link
    runs-on: ubuntu-latest
    # Only run if the build workflow succeeded, was triggered by a pull request,
    # and the PR is from the same repository (not a fork) to prevent privilege escalation
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.head_repository.full_name == github.repository
    permissions:
      contents: read
      actions: read
      pages: write
      id-token: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Get PR number and metadata
        id: pr
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${github.event.workflow_run.head_branch}`
            });

            if (pullRequests.length === 0) {
              core.setFailed('No open PR found for this branch');
              return;
            }

            const pr = pullRequests[0];
            core.setOutput('number', pr.number);
            core.setOutput('branch', github.event.workflow_run.head_branch);
            core.setOutput('commit', github.event.workflow_run.head_sha.slice(0, 7));

      - name: Download artifact from workflow run
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5.0.0
        with:
          name: ${{ vars.PLUGIN_NAME || 'bluehost-wordpress-plugin' }}
          path: ./artifact
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Prepare plugin zip for GitHub Pages
        id: prepare
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          # Create previews directory structure
          mkdir -p gh-pages/previews

          # Create zip named by PR number only (overwrites on new pushes)
          PR_NUM="${PR_NUMBER}"
          ZIP_NAME="bluehost-pr-${PR_NUM}.zip"

          # Create zip from artifact directory
          cd artifact
          zip -r -9 "../gh-pages/previews/${ZIP_NAME}" .
          cd ..

          # Calculate file size for display
          SIZE=$(du -h "gh-pages/previews/${ZIP_NAME}" | cut -f1)

          echo "zip_name=${ZIP_NAME}" >> "$GITHUB_OUTPUT"
          echo "zip_size=${SIZE}" >> "$GITHUB_OUTPUT"

          # Create or update index.html for preview directory
          cat > gh-pages/previews/index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>Bluehost Plugin - Playground Previews</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
              h1 { color: #333; }
              .preview { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
              a { color: #0969da; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>üéÆ WordPress Playground Previews</h1>
            <p>Preview builds of the Bluehost WordPress Plugin for testing in WordPress Playground.</p>
            <div class="preview">
              <p><strong>Latest:</strong> <a href="${ZIP_NAME}">${ZIP_NAME}</a> (${SIZE})</p>
            </div>
          </body>
          </html>
          EOF

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b  # v4.0.0
        with:
          path: ./gh-pages

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e  # v4.0.5

      - name: Create WordPress Playground preview link
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          ZIP_NAME: ${{ steps.prepare.outputs.zip_name }}
          ZIP_SIZE: ${{ steps.prepare.outputs.zip_size }}
          COMMIT: ${{ steps.pr.outputs.commit }}
          BRANCH: ${{ steps.pr.outputs.branch }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);
            const zipName = process.env.ZIP_NAME;
            const zipSize = process.env.ZIP_SIZE;
            const commit = process.env.COMMIT;
            const branch = process.env.BRANCH;

            // Construct the public URL for the zip file on GitHub Pages
            const zipUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/previews/${zipName}`;

            // Create blueprint for WordPress Playground
            // This blueprint installs the plugin from the GitHub Pages URL
            const blueprint = {
              "landingPage": "/wp-admin/admin.php?page=bluehost#/home",
              "preferredVersions": {
                "php": "8.1",
                "wp": "latest"
              },
              "login": true,
              "steps": [
                {
                  "step": "installPlugin",
                  "pluginData": {
                    "resource": "url",
                    "url": zipUrl
                  },
                  "options": {
                    "activate": true
                  }
                }
              ]
            };

            // Base64 encode the blueprint for URL embedding
            const blueprintJson = JSON.stringify(blueprint);
            const blueprintBase64 = Buffer.from(blueprintJson).toString('base64');
            const playgroundUrl = `https://playground.wordpress.net/#${blueprintBase64}`;

            // Create comment body
            const commentMeta = '<!-- playground-preview-link -->';
            const commentBody = `
            ${commentMeta}
            ## üéÆ WordPress Playground Preview

            [**‚ñ∂Ô∏è Launch Preview in Playground**](${playgroundUrl})

            _One-click testing in your browser! The plugin will be automatically installed and activated from this PR's latest build._

            ---

            **Preview Details:**
            - üì¶ Build: \`${zipName}\` (${zipSize})
            - üóÇÔ∏è Branch: \`${branch}\`
            - üìù Latest Commit: \`${commit}\`
            - üîó [Direct Download](${zipUrl})

            <details>
            <summary>‚ÑπÔ∏è About Playground Previews</summary>

            This preview runs your plugin in a complete WordPress environment directly in your browser using WordPress Playground. No local setup required!

            **Features:**
            - ‚úÖ Real WordPress environment (PHP 8.1, Latest WordPress)
            - ‚úÖ Plugin automatically installed & activated
            - ‚úÖ Lands on the Bluehost admin page
            - ‚úÖ Pre-authenticated as admin
            - ‚úÖ Changes persist during your session
            - ‚úÖ Safe sandbox environment

            **Note:** This preview link updates automatically with each new commit. The preview always shows the latest code from this PR.
            </details>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.find(c => c.body.includes(commentMeta));

            // Update or create comment
            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody,
              });
              core.info(`Updated comment ${existingComment.id} on PR #${prNumber}`);
            } else {
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody,
              });
              core.info(`Created new comment on PR #${prNumber}`);
            }

            core.info(`Playground URL: ${playgroundUrl}`);
